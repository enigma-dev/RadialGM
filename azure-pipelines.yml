variables:
  vcpkgGitRef: 1be75a28bfce2084bb0b59ec92a6853f13d7be66 # Update this git ref to update vcpkg
  grpcGitRef: a747a50cc12e21f09001aac622ce649b556d5a10 # Update this git ref to update grpc

jobs:
- job: Ubuntu
  displayName: 'RadialGM Ubuntu'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self
    submodules: true
    persistCredentials: true

  - script: |
      sudo apt-get update
      sudo apt-get -y install build-essential cmake libprotobuf-dev protobuf-compiler zlib1g-dev libboost-dev libboost-filesystem-dev libboost-system-dev libboost-program-options-dev libboost-iostreams-dev libglm-dev libpng-dev pulseaudio libpugixml-dev libyaml-cpp-dev rapidjson-dev qtbase5-dev libqscintilla2-dev
    displayName: 'Dependencies'

  - task: Cache@2
    displayName: 'Cache gRPC'
    inputs:
      key: $(grpcGitRef) | "$(Agent.OS)"
      path: '$(Build.BinariesDirectory)/gRPC'
      cacheHitVar: CACHE_RESTORED

  - script: |
      git clone https://github.com/grpc/grpc.git $(Build.BinariesDirectory)/gRPC
      cd $(Build.BinariesDirectory)/gRPC
      git submodule update --init
      git checkout $(grpcGitRef)
      mkdir grpcBuild && cd grpcBuild
      cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX="/usr" ..
      mkdir protoBuild && cd protoBuild
      cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX="./usr" -Dprotobuf_BUILD_TESTS=OFF ../../third_party/protobuf/cmake
    displayName: 'Build gRPC'
    condition: ne(variables.CACHE_RESTORED, 'true')

  - script: |
      cd $(Build.BinariesDirectory)/gRPC/grpcBuild
      sudo make install
      cd protoBuild
      sudo make install
    displayName: 'Install gRPC'

  - task: CMake@1
    displayName: 'CMake - Release'
    inputs:
      workingDirectory: $(Build.BinariesDirectory)/build-Release
      cmakeArgs: '-G "Unix Makefiles" -DCMAKE_BUILD_TYPE="MinSizeRel" "$(Build.SourcesDirectory)"'
  - script: |
      cmake --build $(Build.BinariesDirectory)/build-Release --config MinSizeRel
      cmake --install $(Build.BinariesDirectory)/build-Release --config MinSizeRel
    displayName: 'Build - Release'

  - task: CMake@1
    displayName: 'CMake - Debug'
    inputs:
      workingDirectory: $(Build.BinariesDirectory)/build-Debug
      cmakeArgs: '-G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Debug $(Build.SourcesDirectory)'
  - script: |
      cmake --build $(Build.BinariesDirectory)/build-Debug --config Debug
      cmake --install $(Build.BinariesDirectory)/build-Debug --config Debug
    displayName: 'Build - Release'

    
- job: RadialGM_MSVC_64
  displayName: 'RadialGM MSVC x64'
  pool:
    vmImage: 'windows-latest'
  timeoutInMinutes: 250

  steps:
  - checkout: self
    submodules: true
    persistCredentials: true

  - task: Cache@2
    displayName: 'Cache VCPKG Artifacts'
    inputs:
      key: $(Build.SourcesDirectory)/msvc-x64-deps.txt | "$(vcpkgGitRef)" | "$(Agent.OS)"
      path: '$(Build.BinariesDirectory)/vcpkg'
  - task: run-vcpkg@0
    displayName: 'Run VCPKG'
    inputs:
      vcpkgArguments: "@$(Build.SourcesDirectory)/msvc-x64-deps.txt"
      vcpkgGitCommitId: $(vcpkgGitRef)
      vcpkgGitURL: https://github.com/microsoft/vcpkg.git

  - task: CMake@1
    displayName: 'CMake - Release'
    inputs:
      workingDirectory: $(Build.BinariesDirectory)/build-Release
      cmakeArgs: '-G "Visual Studio 16 2019" -A "x64" -DVCPKG_ROOT="$(Build.BinariesDirectory)\vcpkg" -DCMAKE_BUILD_TYPE="MinSizeRel" -DVCPKG_TARGET_TRIPLET="x64-windows" -DPROTOBUF_IMPORT_DIRS="$(Build.BinariesDirectory)\vcpkg\installed\x64-windows\include -DCMAKE_TOOLCHAIN_FILE="$(Build.BinariesDirectory)\vcpkg\scripts\buildsystems\vcpkg.cmake" "$(Build.SourcesDirectory)"'
  - script: |
      cmake --build $(Build.BinariesDirectory)/build-Release --target ALL_BUILD --config MinSizeRel
      cmake --install $(Build.BinariesDirectory)/build-Release --config MinSizeRel
      if [ $? -ne 0 ]; then
        exit 1
      fi
    displayName: 'Build - Release'

  - task: CMake@1
    displayName: 'CMake - Debug'
    inputs:
      workingDirectory: $(Build.BinariesDirectory)/build-Debug
      cmakeArgs: '-G "Visual Studio 16 2019" -A "x64" -DVCPKG_ROOT="$(Build.BinariesDirectory)\vcpkg" -DCMAKE_BUILD_TYPE="Debug" -DVCPKG_TARGET_TRIPLET="x64-windows" -DPROTOBUF_IMPORT_DIRS="$(Build.BinariesDirectory)\vcpkg\installed\x64-windows\include -DCMAKE_TOOLCHAIN_FILE="$(Build.BinariesDirectory)\vcpkg\scripts\buildsystems\vcpkg.cmake" "$(Build.SourcesDirectory)"'
  - script: |
      cmake --build $(Build.BinariesDirectory)/build-Debug --config Debug
      cmake --install $(Build.BinariesDirectory)/build-Debug --config Debug
      if [ $? -ne 0 ]; then
        exit 1
      fi
    displayName: 'Build - Debug'

  - script: |
      7z a $(Build.BinariesDirectory)/RadialGM-MSVC-x64.exe -mmt -mx5 -sfx $(Build.SourcesDirectory)/Submodules/enigma-dev
      cd $(Build.SourcesDirectory)/Submodules/enigma-dev && git clean -fx
    displayName: 'Package'