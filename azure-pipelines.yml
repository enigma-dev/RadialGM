variables:
  vcpkgGitRef: 1be75a28bfce2084bb0b59ec92a6853f13d7be66 # Update this git ref to update vcpkg

jobs:
- job: Ubuntu
  displayName: 'RadialGM Linux'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self
    submodules: true
    persistCredentials: true
    path: RGM

  - script: |
      cd $(Build.BinariesDirectory)
      curl http://mirrors.acm.wpi.edu/archlinux/iso/latest/archlinux-bootstrap-2020.02.01-x86_64.tar.gz -o arch.tar.gz
      sudo tar xzf arch.tar.gz
      sudo mount --bind ./root.x86_64/ ./root.x86_64/
      sudo cp -R  $(Build.SourcesDirectory) ./root.x86_64/
      cat << EOF | sudo ./root.x86_64/bin/arch-chroot ./root.x86_64/
      echo 'Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch' >> /etc/pacman.d/mirrorlist
      pacman-key --init 
      pacman-key --populate archlinux
      pacman -Sy --noconfirm base base-devel git gcc cmake protobuf yaml-cpp pugixml rapidjson boost qt5 qscintilla-qt5
      mkdir grpc
      cd grpc
      curl https://pastebin.com/raw/njXhAKw2 -o PKGBUILD
      makepkg -si
      EOF
    displayName: 'Bootstrap Archlinux'

  - script: |
      cd $(Build.BinariesDirectory)
      sudo cp -R  $(Build.SourcesDirectory) ./root.x86_64/
      cat << EOF | sudo ./root.x86_64/bin/arch-chroot ./root.x86_64/
      cd RGM
      mkdir build
      cd build
      cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=MinSizeRel ..
      make
      make install
      sudo rm -rf RGM/
      EOF
    displayName: 'Arch Release Build'