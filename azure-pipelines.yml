variables:
  vcpkgGitRef: 1be75a28bfce2084bb0b59ec92a6853f13d7be66

jobs:
- job: RadialGM_MSVC_64
  pool:
    vmImage: 'windows-latest'
  timeoutInMinutes: 250

  steps:
  - checkout: self
  submodules: true
  persistCredentials: true

  - task: Cache@2
    displayName: 'Cache vcpkgs artifacts'
    inputs:
      key: $(Build.SourcesDirectory)/msvc-static-64.txt | "$(vcpkgGitRef)" | "$(Agent.OS)"
      path: '$(Build.BinariesDirectory)/vcpkg'
  - task: run-vcpkg@0
    displayName: 'Run vcpkg'
    inputs:
      vcpkgArguments: "@$(Build.SourcesDirectory)/msvc-static-64.txt"
      vcpkgGitCommitId: $(vcpkgGitRef)
      vcpkgGitURL: https://github.com/microsoft/vcpkg.git

  - task: run-cmake@0
    displayName: 'Debug Build'
    inputs:
      cmakeListsOrSettingsJson: 'CMakeListsTxtBasic'
      cmakeListsTxtPath: 'CmakeLists.txt'
      cmakeGenerator: VS16Win64
      cmakeBuildType: Debug
      buildDirectory: 'build'
      useVcpkgToolchainFile: true
      vcpkgTriplet: x64-windows-static
      cmakeAppendedArgs: -DPROTOBUF_IMPORT_DIRS="%VCPKG_DIR%\installed\%TRIPLET_NAME%\include"
  - task: run-cmake@0
    displayName: 'Release Build'
    inputs:
      cmakeListsOrSettingsJson: 'CMakeListsTxtBasic'
      cmakeListsTxtPath: 'CMakeLists.txt'
      cmakeGenerator: VS16Win64
      cmakeBuildType: MinSizeRel
      buildDirectory: 'build'
      useVcpkgToolchainFile: true
      vcpkgTriplet: x64-windows-static
      cmakeAppendedArgs: -DPROTOBUF_IMPORT_DIRS="%VCPKG_DIR%\installed\%TRIPLET_NAME%\include"
