variables:
  vcpkgGitRef: 1be75a28bfce2084bb0b59ec92a6853f13d7be66 # Update this git ref to update vcpkg

jobs:
- job: Ubuntu
  displayName: 'RadialGM Linux'
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self
    submodules: true
    persistCredentials: true
    path: RGM

  - script: |
      cd $(Build.BinariesDirectory)
      curl http://mirrors.acm.wpi.edu/archlinux/iso/latest/archlinux-bootstrap-2020.02.01-x86_64.tar.gz -o arch.tar.gz
      sudo tar xzf arch.tar.gz
      sudo cp -R  $(Build.SourcesDirectory) ./root.x86_64/
      cat << EOF | sudo ./root.x86_64/bin/arch-chroot ./root.x86_64/
      'echo Server = https://mirrors.kernel.org/archlinux/\$repo/os/\$arch >> /etc/pacman.d/mirrorlist'
      tail /etc/pacman.d/mirrorlist
      pacman-key --init 
      pacman-key --populate archlinux
      pacman -Sy git gcc cmake protobuf grpc yaml-cpp pugixml rapidjson boost qt5 qscintilla
      EOF
    displayName: 'Bootstrap Archlinux'

  - script: |
      cat << EOF | sudo ./root.x86_64/bin/arch-chroot ./root.x86_64/
      cd RGM
      mkdir build
      cd build
      cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=MinSizeRel ..
      make
      make install
      EOF
    displayName: 'Arch Release Build'